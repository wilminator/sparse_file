name: CI-CD

on: [push, pull_request]

jobs:
  get_branch:
    runs-on: ubuntu-latest
    outputs:
      branch: ${{steps.extract_branch.outputs.branch }}
    steps:
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch

  quality:
    needs: get_branch
    uses: ./.github/workflows/quality.yml

  release:
    # Only run if the quality check succeeded
    needs: 
      - get_branch
      - quality

    # IMPORTANT: this permission is mandatory for trusted publishing
    permissions:
      id-token: write
      contents: write

    # Only if this is a push to main without a tag. The tag being pushed will create a new workflow trigger.
    if: github.event_name == 'push' && github.event.ref == 'refs/heads/main'

    uses: ./.github/workflows/release.yml
    secrets: inherit

  deploy:
    # Only run if the release action succeeded
    needs: 
      - get_branch
      - release

    uses: ./.github/workflows/deploy.yml
    if: needs.release.outputs.released == 'true'